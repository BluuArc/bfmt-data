!function(){"use strict";const e=Symbol("Comlink.proxy"),t=Symbol("Comlink.endpoint"),r=Symbol("Comlink.releaseProxy"),n=Symbol("Comlink.thrown"),a=e=>"object"==typeof e&&null!==e||"function"==typeof e,s=new Map([["proxy",{canHandle:t=>a(t)&&t[e],serialize(e){const{port1:t,port2:r}=new MessageChannel;return o(e,t),[r,[r]]},deserialize(e){return e.start(),function e(n,a=[],s=function(){}){let o=!1;const l=new Proxy(s,{get(t,s){if(c(o),s===r)return()=>p(n,{type:5,path:a.map(e=>e.toString())}).then(()=>{i(n),o=!0});if("then"===s){if(0===a.length)return{then:()=>l};const e=p(n,{type:0,path:a.map(e=>e.toString())}).then(m);return e.then.bind(e)}return e(n,[...a,s])},set(e,t,r){c(o);const[s,i]=h(r);return p(n,{type:1,path:[...a,t].map(e=>e.toString()),value:s},i).then(m)},apply(r,s,i){c(o);const l=a[a.length-1];if(l===t)return p(n,{type:4}).then(m);if("bind"===l)return e(n,a.slice(0,-1));const[h,d]=u(i);return p(n,{type:2,path:a.map(e=>e.toString()),argumentList:h},d).then(m)},construct(e,t){c(o);const[r,s]=u(t);return p(n,{type:3,path:a.map(e=>e.toString()),argumentList:r},s).then(m)}});return l}(e,[],n);var n}}],["throw",{canHandle:e=>a(e)&&n in e,serialize({value:e}){let t;return t=e instanceof Error?{isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:{isError:!1,value:e},[t,[]]},deserialize(e){if(e.isError)throw Object.assign(new Error(e.value.message),e.value);throw e.value}}]]);function o(t,r=self){r.addEventListener("message",(function a(s){if(!s||!s.data)return;const{id:c,type:u,path:p}=Object.assign({path:[]},s.data),d=(s.data.argumentList||[]).map(m);let y;try{const r=p.slice(0,-1).reduce((e,t)=>e[t],t),n=p.reduce((e,t)=>e[t],t);switch(u){case 0:y=n;break;case 1:r[p.slice(-1)[0]]=m(s.data.value),y=!0;break;case 2:y=n.apply(r,d);break;case 3:y=function(t){return Object.assign(t,{[e]:!0})}(new n(...d));break;case 4:{const{port1:e,port2:r}=new MessageChannel;o(t,r),y=function(e,t){return l.set(e,t),e}(e,[e])}break;case 5:y=void 0}}catch(e){y={value:e,[n]:0}}Promise.resolve(y).catch(e=>({value:e,[n]:0})).then(e=>{const[t,n]=h(e);r.postMessage(Object.assign(Object.assign({},t),{id:c}),n),5===u&&(r.removeEventListener("message",a),i(r))})})),r.start&&r.start()}function i(e){(function(e){return"MessagePort"===e.constructor.name})(e)&&e.close()}function c(e){if(e)throw new Error("Proxy has been released and is not useable")}function u(e){const t=e.map(h);return[t.map(e=>e[0]),(r=t.map(e=>e[1]),Array.prototype.concat.apply([],r))];var r}const l=new WeakMap;function h(e){for(const[t,r]of s)if(r.canHandle(e)){const[n,a]=r.serialize(e);return[{type:3,name:t,value:n},a]}return[{type:0,value:e},l.get(e)||[]]}function m(e){switch(e.type){case 3:return s.get(e.name).deserialize(e.value);case 0:return e.value}}function p(e,t,r){return new Promise(n=>{const a=new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-");e.addEventListener("message",(function t(r){r.data&&r.data.id&&r.data.id===a&&(e.removeEventListener("message",t),n(r.data))})),e.start&&e.start(),e.postMessage(Object.assign({id:a},t),r)})}const d={burst:["desc","name"],dictionary:[],"extra-skill":["desc","name"],item:["desc","name","thumbnail"],"leader-skill":["desc","name"],mission:["desc","name"],unit:["name"]},y={ID:({key:e},{key:t})=>(""+e).localeCompare(""+t),"Update Date":({key:e,value:t},{key:r,value:n})=>{let a=new Date(t.bfmtMetadata.updatedAt)-new Date(n.bfmtMetadata.updatedAt);return 0===a&&(a=y.ID([e],[r])),a}},f=new Map;let g={searchKey:"",results:[]};function w(e=[]){g={searchKey:`${Math.random()}-${Date.now()}`,results:e}}function v(e,t){return`${e}-${t}`}function b(e,t,{sortType:r="ID",sortMultiplier:n=1,maxResultSize:a=50}={}){const s=v(e,t);let o=f.get(s);return o||(o=S(e,t,"bfmt_update-stats"),f.set(s,o)),o.then(e=>{const t=y[r]||y.ID,s=Object.entries(e).map(([e,t])=>({key:e,value:t})).sort((...e)=>n*t(...e));return w(s),{searchKey:g.searchKey,totalEntries:s.length,results:s.slice(0,a)}})}function S(e,t,r){return n=`https://joshuacastor.me/bfmt-data/${e}/${t}/${r}.json?v=${Date.now()}`,fetch(n,{cache:"no-store"}).then(e=>e.ok?e.json():Promise.reject({status:e.status,statusText:e.statusText}));var n}o({getUpdateStatsForServerAndDataType:b,getEntriesForSearch:async function(e,t,{filters:r={},sortType:n="ID",sortMultiplier:a=1,maxResultSize:s=50}={}){await b(e,t);const o=v(e,t),i=await f.get(o);let c=[];const u=Object.entries(i);if(r.text){const e=d[t]||[],n=(""+r.text).toLowerCase().trim();if(n){const t=e=>!!e&&(""+e).toLowerCase().includes(n);c=u.filter(([r,n])=>t(r)||n&&e.some(e=>t(n[e])))}}else c=u;const l=y[n]||y.ID;return c=c.map(([e,t])=>({key:e,value:t})).sort((...e)=>a*l(...e)),w(c),{searchKey:g.searchKey,totalEntries:c.length,results:c.slice(0,s)}},updateSearchContextSort:function(e,{sortType:t="ID",sortMultiplier:r=1,maxResultSize:n=50}={}){if(!g||!g.searchKey)throw new Error("Search not initialized");if(g.searchKey!==e)throw new Error("Search key mismatch");const a=y[t]||y.ID;return g.results=g.results.sort((...e)=>r*a(...e)),{searchKey:g.searchKey,totalEntries:g.results.length,results:g.results.slice(0,n)}},getEntriesInSearchContext:function(e,t,r=50){if(!g||!g.searchKey)throw new Error("Search not initialized");if(g.searchKey!==e)throw new Error("Search key mismatch");return g.results.slice(t,t+r)},getEntry:S})}();
